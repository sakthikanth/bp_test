'use strict';

var _tape = require('tape');

var _tape2 = _interopRequireDefault(_tape);

var _testPixel = require('../test-pixel');

var _testPixel2 = _interopRequireDefault(_testPixel);

var _mesh = require('../../lib/mesh');

var _mesh2 = _interopRequireDefault(_mesh);

var _perspective = require('../../lib/camera/perspective');

var _perspective2 = _interopRequireDefault(_perspective);

var _flat = require('../../lib/material/flat');

var _flat2 = _interopRequireDefault(_flat);

var _forward = require('../../lib/renderer/forward');

var _forward2 = _interopRequireDefault(_forward);

var _scene = require('../../lib/scene');

var _scene2 = _interopRequireDefault(_scene);

var _geometry = require('../../lib/geometry');

var _geometry2 = _interopRequireDefault(_geometry);

var _geo3dBox = require('geo-3d-box');

var _geo3dBox2 = _interopRequireDefault(_geo3dBox);

var _scene3 = require('../../lib/pass/scene');

var _scene4 = _interopRequireDefault(_scene3);

var _bloom = require('../../lib/pass/bloom');

var _bloom2 = _interopRequireDefault(_bloom);

var _multipass = require('../../lib/renderer/multipass');

var _multipass2 = _interopRequireDefault(_multipass);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _tape2.default)('Bloom Pass', function (t) {
  var scene = (0, _scene2.default)({
    autoStart: false,
    renderer: (0, _forward2.default)({
      autoResizeCanvas: false,
      width: 100,
      height: 100
    })
  });
  var gl = scene.renderer.gl;
  var camera = (0, _perspective2.default)();
  var redMaterial = (0, _flat2.default)();
  var blackMaterial = (0, _flat2.default)();
  var geometry = (0, _geometry2.default)((0, _geo3dBox2.default)({ size: 5 }));
  var redMesh = (0, _mesh2.default)(geometry, redMaterial);
  var blackMesh = (0, _mesh2.default)(geometry, blackMaterial);
  var testPixel = (0, _testPixel2.default)(t, gl);
  var multipass = (0, _multipass2.default)(scene.renderer).use((0, _scene4.default)({ scene: scene, camera: camera })).use((0, _bloom2.default)({
    intensity: 10,
    kernelSize: 0.3,
    power: 2
  }));

  scene.add(camera);
  scene.add(redMesh);
  scene.add(blackMesh);

  redMaterial.shading.color = [1, 0, 0];
  redMesh.position[2] = 0;
  blackMaterial.shading.color = [0, 0, 0.5];
  blackMesh.position[2] = -1;
  blackMesh.scale[0] = 4;
  blackMesh.scale[1] = 4;
  camera.position[2] = 20;

  t.test('creates a scene pass with a red box', function (t) {
    multipass.render(camera);

    testPixel(50, 50, [255, 0, 0], 'The center is red');
    testPixel(35, 35, [255, 0, 169], 'The top left has some background in it');
    testPixel(65, 65, [255, 0, 147], 'The bottom right is red');
    testPixel(50, 30, [169, 0, 255], 'There is a bit of red blur at the top edge');
    testPixel(50, 80, [79, 0, 255], 'There is a bit of red blur at the bottom edge');
    testPixel(30, 50, [169, 0, 255], 'there is a bit of red blur at the left edge');
    testPixel(80, 50, [79, 0, 255], 'there is a bit of red blur at the right edge');
    testPixel(2, 2, [0, 0, 255], 'The top left outside is blue');
    testPixel(98, 98, [0, 0, 255], 'The bottom right outside is blue');

    t.end();

    multipass.destroy();
    scene.renderer.destroy();
  });
});