'use strict';

var _tape = require('tape');

var _tape2 = _interopRequireDefault(_tape);

var _testPixel = require('../test-pixel');

var _testPixel2 = _interopRequireDefault(_testPixel);

var _mesh = require('../../lib/mesh');

var _mesh2 = _interopRequireDefault(_mesh);

var _perspective = require('../../lib/camera/perspective');

var _perspective2 = _interopRequireDefault(_perspective);

var _flat = require('../../lib/material/flat');

var _flat2 = _interopRequireDefault(_flat);

var _forward = require('../../lib/renderer/forward');

var _forward2 = _interopRequireDefault(_forward);

var _scene = require('../../lib/scene');

var _scene2 = _interopRequireDefault(_scene);

var _geometry = require('../../lib/geometry');

var _geometry2 = _interopRequireDefault(_geometry);

var _geo3dBox = require('geo-3d-box');

var _geo3dBox2 = _interopRequireDefault(_geo3dBox);

var _scene3 = require('../../lib/pass/scene');

var _scene4 = _interopRequireDefault(_scene3);

var _depth = require('../../lib/pass/depth');

var _depth2 = _interopRequireDefault(_depth);

var _multipass = require('../../lib/renderer/multipass');

var _multipass2 = _interopRequireDefault(_multipass);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _tape2.default)('Depth Pass', function (t) {
  var scene = (0, _scene2.default)({
    autoStart: false,
    renderer: (0, _forward2.default)({
      autoResizeCanvas: false,
      width: 100,
      height: 100
    })
  });
  var gl = scene.renderer.gl;
  var camera = (0, _perspective2.default)();
  var material = (0, _flat2.default)();
  var geometry = (0, _geometry2.default)((0, _geo3dBox2.default)({ size: 5 }));
  var nearMesh = (0, _mesh2.default)(geometry, material);
  var farMesh = (0, _mesh2.default)(geometry, material);
  var testPixel = (0, _testPixel2.default)(t, gl);
  var multipass = (0, _multipass2.default)(scene.renderer).use((0, _scene4.default)({ scene: scene, camera: camera })).use((0, _depth2.default)());

  scene.add(camera);
  scene.add(nearMesh);
  scene.add(farMesh);

  nearMesh.position[2] = 0;
  farMesh.position[2] = -1;
  farMesh.scale[0] = 4;
  farMesh.scale[1] = 4;
  camera.position[2] = 20;

  t.test('creates a scene pass with a red box', function (t) {
    multipass.render(camera);

    testPixel(50, 50, [96, 96, 96], 'The center is red');
    testPixel(35, 35, [96, 96, 96], 'The top left is red');
    testPixel(65, 65, [96, 96, 96], 'The bottom right is red');
    testPixel(30, 30, [103, 103, 103], 'The top left outside is white');
    testPixel(70, 70, [103, 103, 103], 'The bottom right outside is white');

    t.end();

    multipass.destroy();
    scene.renderer.destroy();
  });
});